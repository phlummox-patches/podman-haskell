<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP, BangPatterns, PatternGuards #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DeriveDataTypeable, ScopedTypeVariables #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Codec.Archive.Tar.Index.IntTrie</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span>  </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-type">IntTrie</span></a><span class="hs-special">,</span><span>
</span><a name="line-7"></a><span>  </span><a href="Codec.Archive.Tar.Index.IntTrie.html#construct"><span class="hs-identifier hs-var">construct</span></a><span class="hs-special">,</span><span>
</span><a name="line-8"></a><span>  </span><a href="Codec.Archive.Tar.Index.IntTrie.html#toList"><span class="hs-identifier hs-var">toList</span></a><span class="hs-special">,</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span>  </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>  </span><a href="Codec.Archive.Tar.Index.IntTrie.html#empty"><span class="hs-identifier hs-var">empty</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>  </span><a href="Codec.Archive.Tar.Index.IntTrie.html#insert"><span class="hs-identifier hs-var">insert</span></a><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>  </span><a href="Codec.Archive.Tar.Index.IntTrie.html#finalise"><span class="hs-identifier hs-var">finalise</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>  </span><a href="Codec.Archive.Tar.Index.IntTrie.html#unfinalise"><span class="hs-identifier hs-var">unfinalise</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span>  </span><a href="Codec.Archive.Tar.Index.IntTrie.html#lookup"><span class="hs-identifier hs-var">lookup</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>  </span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieLookup"><span class="hs-identifier hs-type">TrieLookup</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span>  </span><a href="Codec.Archive.Tar.Index.IntTrie.html#serialise"><span class="hs-identifier hs-var">serialise</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>  </span><a href="Codec.Archive.Tar.Index.IntTrie.html#serialiseSize"><span class="hs-identifier hs-var">serialiseSize</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>  </span><a href="Codec.Archive.Tar.Index.IntTrie.html#deserialise"><span class="hs-identifier hs-var">deserialise</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-cpp">#ifdef TESTS
</span><span>  </span><span class="hs-identifier">test1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">test2</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">test3</span><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>  </span><span class="hs-identifier">ValidPaths</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>  </span><span class="hs-identifier">prop_lookup</span><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>  </span><span class="hs-identifier">prop_completions</span><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>  </span><span class="hs-identifier">prop_lookup_mono</span><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>  </span><span class="hs-identifier">prop_completions_mono</span><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-identifier">prop_construct_toList</span><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>  </span><span class="hs-identifier">prop_finalise_unfinalise</span><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>  </span><span class="hs-identifier">prop_serialise_deserialise</span><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>  </span><span class="hs-identifier">prop_serialiseSize</span><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span class="hs-cpp">#endif
</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookup</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Typeable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Array.Unboxed</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Array.IArray</span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Bits</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Bits</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Word</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Word32</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Bits</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Monoid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monoid</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-cpp">#if (MIN_VERSION_base(4,5,0))
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Monoid</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-cpp">#endif
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString</span><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy</span><span>   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LBS</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Unsafe</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-53"></a><span class="hs-cpp">#if MIN_VERSION_bytestring(0,10,2) || defined(MIN_VERSION_bytestring_builder)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.ByteString.Builder</span><span>          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-55"></a><span class="hs-cpp">#else
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy.Builder</span><span>     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-57"></a><span class="hs-cpp">#endif
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">assert</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-cpp">#if MIN_VERSION_containers(0,5,0)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntMap.Strict</span><span>     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IntMap</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IntMap.Strict</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IntMap</span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span class="hs-cpp">#else
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntMap</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IntMap</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IntMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">IntMap</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookup</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">insert</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Function</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">on</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-cpp">#ifdef TESTS
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Test.QuickCheck</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator">&lt;$&gt;</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator">&lt;*&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-comment">-- | A compact mapping from sequences of nats to nats.</span><span>
</span><a name="line-79"></a><span class="hs-comment">--</span><span>
</span><a name="line-80"></a><span class="hs-comment">-- NOTE: The tries in this module have values /only/ at the leaves (which</span><span>
</span><a name="line-81"></a><span class="hs-comment">-- correspond to files), they do not have values at the branch points (which</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- correspond to directories).</span><span>
</span><a name="line-83"></a><span class="hs-keyword">newtype</span><span> </span><a name="IntTrie"><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier">IntTrie</span></a></a><span> </span><a name="local-6989586621679038206"><a href="#local-6989586621679038206"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679038207"><a href="#local-6989586621679038207"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="IntTrie"><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier">IntTrie</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">A.UArray</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-identifier hs-type">Word32</span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-comment">-- Compact, read-only implementation of a trie. It's intended for use with file</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- paths, but we do that via string ids.</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-cpp">#ifdef TESTS
</span><span class="hs-comment">-- Example mapping:</span><span>
</span><a name="line-92"></a><span class="hs-comment">--</span><span>
</span><a name="line-93"></a><span class="hs-identifier">example0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Int</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-94"></a><span class="hs-identifier">example0</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-95"></a><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-string">&quot;foo-1.0/foo-1.0.cabal&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-number">512</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- tar block 1</span><span>
</span><a name="line-96"></a><span>  </span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-string">&quot;foo-1.0/LICENSE&quot;</span><span class="hs-special">,</span><span>       </span><span class="hs-number">2048</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- tar block 4</span><span>
</span><a name="line-97"></a><span>  </span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-string">&quot;foo-1.0/Data/Foo.hs&quot;</span><span class="hs-special">,</span><span>   </span><span class="hs-number">4096</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- tar block 8</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span class="hs-comment">-- After converting path components to integers this becomes:</span><span>
</span><a name="line-100"></a><span class="hs-comment">--</span><span>
</span><a name="line-101"></a><span class="hs-identifier">example1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier">Word32</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Word32</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-102"></a><span class="hs-identifier">example1</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-103"></a><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">2</span><span class="hs-special">]</span><span class="hs-special">,</span><span>   </span><span class="hs-number">512</span><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>  </span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">3</span><span class="hs-special">]</span><span class="hs-special">,</span><span>   </span><span class="hs-number">2048</span><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span>  </span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">4</span><span class="hs-special">,</span><span class="hs-number">5</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-number">4096</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-comment">-- As a trie this looks like:</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span class="hs-comment">--  [ (1, *) ]</span><span>
</span><a name="line-110"></a><span class="hs-comment">--        |</span><span>
</span><a name="line-111"></a><span class="hs-comment">--        [ (2, 512), (3, 1024), (4, *) ]</span><span>
</span><a name="line-112"></a><span class="hs-comment">--                                   |</span><span>
</span><a name="line-113"></a><span class="hs-comment">--                                   [ (5, 4096) ]</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-comment">-- We use an intermediate trie representation</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-identifier">mktrie</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TrieNode</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IntTrieBuilder</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">v</span><span>
</span><a name="line-118"></a><span class="hs-identifier">mkleaf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Enum</span><span> </span><span class="hs-identifier">k</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Enum</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">v</span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TrieNode</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span class="hs-identifier">mknode</span><span> </span><span class="hs-glyph">::</span><span>  </span><span class="hs-identifier">Enum</span><span> </span><span class="hs-identifier">k</span><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IntTrieBuilder</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TrieNode</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-identifier">mktrie</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">IntTrieBuilder</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">IntMap.fromList</span><span>
</span><a name="line-122"></a><span class="hs-identifier">mkleaf</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromEnum</span><span> </span><span class="hs-identifier">k</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TrieLeaf</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">enumToWord32</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span class="hs-identifier">mknode</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">t</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromEnum</span><span> </span><span class="hs-identifier">k</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TrieNode</span><span> </span><span class="hs-identifier">t</span><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-identifier">example2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IntTrieBuilder</span><span> </span><span class="hs-identifier">Word32</span><span> </span><span class="hs-identifier">Word32</span><span>
</span><a name="line-126"></a><span class="hs-identifier">example2</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mknode</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-identifier">t1</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-127"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-128"></a><span>    </span><span class="hs-identifier">t1</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mkleaf</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-number">512</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mkleaf</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-number">2048</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mknode</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-identifier">t2</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-129"></a><span>    </span><span class="hs-identifier">t2</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mkleaf</span><span> </span><span class="hs-number">5</span><span> </span><span class="hs-number">4096</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-identifier">example2'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IntTrieBuilder</span><span> </span><span class="hs-identifier">Word32</span><span> </span><span class="hs-identifier">Word32</span><span>
</span><a name="line-133"></a><span class="hs-identifier">example2'</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mknode</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">t1</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-134"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-135"></a><span>    </span><span class="hs-identifier">t1</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mknode</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-identifier">t2</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-136"></a><span>    </span><span class="hs-identifier">t2</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mknode</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-identifier">t3</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mknode</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-identifier">t4</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-137"></a><span>    </span><span class="hs-identifier">t3</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mkleaf</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-number">10608</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-138"></a><span>    </span><span class="hs-identifier">t4</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mkleaf</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-number">10612</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-139"></a><span class="hs-comment">{-
0: [1,N0,3]

  3: [1,N3,6]

   6: [2,N1,N2,11,12]

     11: [1,4,10608]
     14: [1,4,10612]
-}</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-identifier">example2''</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IntTrieBuilder</span><span> </span><span class="hs-identifier">Word32</span><span> </span><span class="hs-identifier">Word32</span><span>
</span><a name="line-151"></a><span class="hs-identifier">example2''</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mknode</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-identifier">t1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mknode</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-identifier">t2</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-152"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-153"></a><span>    </span><span class="hs-identifier">t1</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mkleaf</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-number">10608</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-154"></a><span>    </span><span class="hs-identifier">t2</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mkleaf</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-number">10612</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-identifier">example2'''</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IntTrieBuilder</span><span> </span><span class="hs-identifier">Word32</span><span> </span><span class="hs-identifier">Word32</span><span>
</span><a name="line-157"></a><span class="hs-identifier">example2'''</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mknode</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">t3</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-158"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-159"></a><span>    </span><span class="hs-identifier">t3</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mknode</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-identifier">t8</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mknode</span><span> </span><span class="hs-number">6</span><span> </span><span class="hs-identifier">t11</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-160"></a><span>    </span><span class="hs-identifier">t8</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mknode</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-identifier">t14</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-161"></a><span>    </span><span class="hs-identifier">t11</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mkleaf</span><span> </span><span class="hs-number">5</span><span> </span><span class="hs-number">10605</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-162"></a><span>    </span><span class="hs-identifier">t14</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mknode</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-identifier">t19</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mknode</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-identifier">t22</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-163"></a><span>    </span><span class="hs-identifier">t19</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mkleaf</span><span> </span><span class="hs-number">7</span><span> </span><span class="hs-number">10608</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-164"></a><span>    </span><span class="hs-identifier">t22</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mktrie</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">mkleaf</span><span> </span><span class="hs-number">7</span><span> </span><span class="hs-number">10612</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-165"></a><span class="hs-comment">{-
 0: [1,N0,3]
 3: [2,N4,N6,8,11]
 8: [1,N1,11]
11: [1,5,10605]
14: [2,N2,N3,16,19]
19: [1,7,10608]
22: [1,7,10612]
-}</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span class="hs-comment">-- We convert from the 'Paths' to the 'IntTrieBuilder' using 'inserts':</span><span>
</span><a name="line-176"></a><span class="hs-comment">--</span><span>
</span><a name="line-177"></a><span class="hs-identifier">test1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">example2</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">inserts</span><span> </span><span class="hs-identifier">example1</span><span> </span><span class="hs-identifier">empty</span><span>
</span><a name="line-178"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-180"></a><span class="hs-comment">-- Each node has a size and a sequence of keys followed by an equal length</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- sequnce of corresponding entries. Since we're going to flatten this into</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- a single array then we will need to replace the trie structure with pointers</span><span>
</span><a name="line-183"></a><span class="hs-comment">-- represented as array offsets.</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-comment">-- Each node is a pair of arrays, one of keys and one of Either value pointer.</span><span>
</span><a name="line-186"></a><span class="hs-comment">-- We need to distinguish values from internal pointers. We use a tag bit:</span><span>
</span><a name="line-187"></a><span class="hs-comment">--</span><span>
</span><a name="line-188"></a><span class="hs-identifier">tagLeaf</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tagNode</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">untag</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word32</span><span>
</span><a name="line-189"></a><a name="tagLeaf"><a href="Codec.Archive.Tar.Index.IntTrie.html#tagLeaf"><span class="hs-identifier">tagLeaf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-190"></a><a name="tagNode"><a href="Codec.Archive.Tar.Index.IntTrie.html#tagNode"><span class="hs-identifier">tagNode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">Bits.setBit</span><span>   </span><span class="hs-number">31</span><span>
</span><a name="line-191"></a><a name="untag"><a href="Codec.Archive.Tar.Index.IntTrie.html#untag"><span class="hs-identifier">untag</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">Bits.clearBit</span><span> </span><span class="hs-number">31</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-identifier">isNode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-194"></a><a name="isNode"><a href="Codec.Archive.Tar.Index.IntTrie.html#isNode"><span class="hs-identifier">isNode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">Bits.testBit</span><span> </span><span class="hs-number">31</span><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span class="hs-comment">-- So the overall array form of the above trie is:</span><span>
</span><a name="line-197"></a><span class="hs-comment">--</span><span>
</span><a name="line-198"></a><span class="hs-comment">-- offset:   0   1    2    3   4  5  6    7    8     9     10  11  12</span><span>
</span><a name="line-199"></a><span class="hs-comment">-- array:  [ 1 | N1 | 3 ][ 3 | 2, 3, N4 | 512, 2048, 10 ][ 1 | 5 | 4096 ]</span><span>
</span><a name="line-200"></a><span class="hs-comment">--                     \__/                           \___/</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-cpp">#ifdef TESTS
</span><span class="hs-identifier">example3</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Word32</span><span class="hs-special">]</span><span>
</span><a name="line-204"></a><span class="hs-identifier">example3</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-205"></a><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tagNode</span><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span>
</span><a name="line-206"></a><span>     </span><span class="hs-number">3</span><span class="hs-special">,</span><span>
</span><a name="line-207"></a><span>  </span><span class="hs-number">3</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tagLeaf</span><span> </span><span class="hs-number">2</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tagLeaf</span><span> </span><span class="hs-number">3</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tagNode</span><span> </span><span class="hs-number">4</span><span class="hs-special">,</span><span>
</span><a name="line-208"></a><span>     </span><span class="hs-number">512</span><span class="hs-special">,</span><span>       </span><span class="hs-number">2048</span><span class="hs-special">,</span><span>      </span><span class="hs-number">10</span><span class="hs-special">,</span><span>
</span><a name="line-209"></a><span>  </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tagLeaf</span><span> </span><span class="hs-number">5</span><span class="hs-special">,</span><span>
</span><a name="line-210"></a><span>     </span><span class="hs-number">4096</span><span>
</span><a name="line-211"></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-comment">-- We get the array form by using flattenTrie:</span><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span class="hs-identifier">test2</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">example3</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">flattenTrie</span><span> </span><span class="hs-identifier">example2</span><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span class="hs-identifier">example4</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IntTrie</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-identifier">Int</span><span>
</span><a name="line-218"></a><span class="hs-identifier">example4</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">IntTrie</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mkArray</span><span> </span><span class="hs-identifier">example3</span><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span class="hs-identifier">mkArray</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">Word32</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">A.UArray</span><span> </span><span class="hs-identifier">Word32</span><span> </span><span class="hs-identifier">Word32</span><span>
</span><a name="line-221"></a><span class="hs-identifier">mkArray</span><span> </span><span class="hs-identifier">xs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">A.listArray</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">length</span><span> </span><span class="hs-identifier">xs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">xs</span><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span class="hs-identifier">test3</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">lookup</span><span> </span><span class="hs-identifier">example4</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-224"></a><span>          </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Completions</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-number">3</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-number">4</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">True</span><span>
</span><a name="line-225"></a><span>          </span><span class="hs-identifier">_</span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">False</span><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span class="hs-identifier">test1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">test2</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">test3</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><a name="line-228"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-230"></a><span class="hs-comment">-------------------------------------</span><span>
</span><a name="line-231"></a><span class="hs-comment">-- Decoding the trie array form</span><span>
</span><a name="line-232"></a><span class="hs-comment">--</span><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span class="hs-identifier">completionsFrom</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040686"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040687"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-type">IntTrie</span></a><span> </span><a href="#local-6989586621679040686"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040687"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Completions"><span class="hs-identifier hs-type">Completions</span></a><span> </span><a href="#local-6989586621679040686"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040687"><span class="hs-identifier hs-type">v</span></a><span>
</span><a name="line-235"></a><a name="completionsFrom"><a href="Codec.Archive.Tar.Index.IntTrie.html#completionsFrom"><span class="hs-identifier">completionsFrom</span></a></a><span> </span><a name="local-6989586621679040688"><a href="#local-6989586621679040688"><span class="hs-identifier">trie</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-var">IntTrie</span></a><span> </span><a name="local-6989586621679040689"><a href="#local-6989586621679040689"><span class="hs-identifier">arr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679040690"><a href="#local-6989586621679040690"><span class="hs-identifier">nodeOff</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-236"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#word32ToEnum"><span class="hs-identifier hs-var">word32ToEnum</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#untag"><span class="hs-identifier hs-var">untag</span></a><span> </span><a href="#local-6989586621679040774"><span class="hs-identifier hs-var">key</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679040776"><span class="hs-identifier hs-var">next</span></a><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679040773"><a href="#local-6989586621679040773"><span class="hs-identifier">keyOff</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679040692"><span class="hs-identifier hs-var">keysStart</span></a><span class="hs-glyph">..</span><a href="#local-6989586621679040693"><span class="hs-identifier hs-var">keysEnd</span></a><span class="hs-special">]</span><span>
</span><a name="line-238"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679040774"><a href="#local-6989586621679040774"><span class="hs-identifier">key</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679040689"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621679040773"><span class="hs-identifier hs-var">keyOff</span></a><span>
</span><a name="line-239"></a><span>          </span><a name="local-6989586621679040775"><a href="#local-6989586621679040775"><span class="hs-identifier">entry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679040689"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679040773"><span class="hs-identifier hs-var">keyOff</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679040691"><span class="hs-identifier hs-var">nodeSize</span></a><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span>          </span><a name="local-6989586621679040776"><a href="#local-6989586621679040776"><span class="hs-identifier">next</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#isNode"><span class="hs-identifier hs-var">isNode</span></a><span> </span><a href="#local-6989586621679040774"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Completions"><span class="hs-identifier hs-var">Completions</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#completionsFrom"><span class="hs-identifier hs-var">completionsFrom</span></a><span> </span><a href="#local-6989586621679040688"><span class="hs-identifier hs-var">trie</span></a><span> </span><a href="#local-6989586621679040775"><span class="hs-identifier hs-var">entry</span></a><span class="hs-special">)</span><span>
</span><a name="line-241"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Entry"><span class="hs-identifier hs-var">Entry</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#word32ToEnum"><span class="hs-identifier hs-var">word32ToEnum</span></a><span> </span><a href="#local-6989586621679040775"><span class="hs-identifier hs-var">entry</span></a><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-243"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-244"></a><span>    </span><a name="local-6989586621679040691"><a href="#local-6989586621679040691"><span class="hs-identifier">nodeSize</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679040689"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621679040690"><span class="hs-identifier hs-var">nodeOff</span></a><span>
</span><a name="line-245"></a><span>    </span><a name="local-6989586621679040692"><a href="#local-6989586621679040692"><span class="hs-identifier">keysStart</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679040690"><span class="hs-identifier hs-var">nodeOff</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-246"></a><span>    </span><a name="local-6989586621679040693"><a href="#local-6989586621679040693"><span class="hs-identifier">keysEnd</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679040690"><span class="hs-identifier hs-var">nodeOff</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679040691"><span class="hs-identifier hs-var">nodeSize</span></a><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span class="hs-comment">-- | Convert the trie to a list</span><span>
</span><a name="line-249"></a><span class="hs-comment">--</span><span>
</span><a name="line-250"></a><span class="hs-comment">-- This is the left inverse to 'construct' (modulo ordering).</span><span>
</span><a name="line-251"></a><span class="hs-identifier">toList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679040684"><a href="#local-6989586621679040684"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679040685"><a href="#local-6989586621679040685"><span class="hs-identifier">v</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040684"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040685"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-type">IntTrie</span></a><span> </span><a href="#local-6989586621679040684"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040685"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621679040684"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679040685"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-252"></a><a name="toList"><a href="Codec.Archive.Tar.Index.IntTrie.html#toList"><span class="hs-identifier">toList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679040777"><span class="hs-identifier hs-var">aux</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Codec.Archive.Tar.Index.IntTrie.html#completionsFrom"><span class="hs-identifier hs-var">completionsFrom</span></a><span class="hs-special">`</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-253"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-254"></a><span>    </span><span class="hs-identifier">aux</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679040684"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679040684"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">,</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieLookup"><span class="hs-identifier hs-type">TrieLookup</span></a><span> </span><a href="#local-6989586621679040684"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040685"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621679040684"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679040685"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-255"></a><span>    </span><a name="local-6989586621679040777"><a href="#local-6989586621679040777"><span class="hs-identifier">aux</span></a></a><span> </span><a name="local-6989586621679040778"><a href="#local-6989586621679040778"><span class="hs-identifier">ks</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679040779"><a href="#local-6989586621679040779"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Entry"><span class="hs-identifier hs-var">Entry</span></a><span> </span><a name="local-6989586621679040780"><a href="#local-6989586621679040780"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679040779"><span class="hs-identifier hs-var">k</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679040778"><span class="hs-identifier hs-var">ks</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679040780"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-256"></a><span>    </span><span class="hs-identifier">aux</span><span> </span><a name="local-6989586621679040971"><a href="#local-6989586621679040971"><span class="hs-identifier">ks</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679040972"><a href="#local-6989586621679040972"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Completions"><span class="hs-identifier hs-var">Completions</span></a><span> </span><a name="local-6989586621679040973"><a href="#local-6989586621679040973"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679040777"><span class="hs-identifier hs-var">aux</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679040972"><span class="hs-identifier hs-var">k</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679040971"><span class="hs-identifier hs-var">ks</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679040973"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-comment">-------------------------------------</span><span>
</span><a name="line-259"></a><span class="hs-comment">-- Toplevel trie array construction</span><span>
</span><a name="line-260"></a><span class="hs-comment">--</span><span>
</span><a name="line-261"></a><span>
</span><a name="line-262"></a><span class="hs-comment">-- So constructing the 'IntTrie' as a whole is just a matter of stringing</span><span>
</span><a name="line-263"></a><span class="hs-comment">-- together all the bits</span><span>
</span><a name="line-264"></a><span>
</span><a name="line-265"></a><span class="hs-comment">-- | Build an 'IntTrie' from a bunch of (key, value) pairs, where the keys</span><span>
</span><a name="line-266"></a><span class="hs-comment">-- are sequences.</span><span>
</span><a name="line-267"></a><span class="hs-comment">--</span><span>
</span><a name="line-268"></a><span class="hs-identifier">construct</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040682"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040683"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621679040682"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679040683"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-type">IntTrie</span></a><span> </span><a href="#local-6989586621679040682"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040683"><span class="hs-identifier hs-type">v</span></a><span>
</span><a name="line-269"></a><a name="construct"><a href="Codec.Archive.Tar.Index.IntTrie.html#construct"><span class="hs-identifier">construct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#finalise"><span class="hs-identifier hs-var">finalise</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#inserts"><span class="hs-identifier hs-var">inserts</span></a><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span>
</span><a name="line-272"></a><span class="hs-comment">---------------------------------</span><span>
</span><a name="line-273"></a><span class="hs-comment">-- Looking up in the trie array</span><span>
</span><a name="line-274"></a><span class="hs-comment">--</span><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span class="hs-keyword">data</span><span> </span><a name="TrieLookup"><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieLookup"><span class="hs-identifier">TrieLookup</span></a></a><span>  </span><a name="local-6989586621679038204"><a href="#local-6989586621679038204"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679038205"><a href="#local-6989586621679038205"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Entry"><a href="Codec.Archive.Tar.Index.IntTrie.html#Entry"><span class="hs-identifier">Entry</span></a></a><span> </span><span class="hs-glyph">!</span><a href="#local-6989586621679038205"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="Completions"><a href="Codec.Archive.Tar.Index.IntTrie.html#Completions"><span class="hs-identifier">Completions</span></a></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#Completions"><span class="hs-identifier hs-type">Completions</span></a><span> </span><a href="#local-6989586621679038204"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679038205"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Show</span><span>
</span><a name="line-277"></a><span class="hs-keyword">type</span><span> </span><a name="Completions"><a href="Codec.Archive.Tar.Index.IntTrie.html#Completions"><span class="hs-identifier">Completions</span></a></a><span> </span><a name="local-6989586621679038202"><a href="#local-6989586621679038202"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679038203"><a href="#local-6989586621679038203"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679038202"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">,</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieLookup"><span class="hs-identifier hs-type">TrieLookup</span></a><span> </span><a href="#local-6989586621679038202"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679038203"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span class="hs-identifier">lookup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679040680"><a href="#local-6989586621679040680"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679040681"><a href="#local-6989586621679040681"><span class="hs-identifier">v</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040680"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040681"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-type">IntTrie</span></a><span> </span><a href="#local-6989586621679040680"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040681"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679040680"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieLookup"><span class="hs-identifier hs-type">TrieLookup</span></a><span> </span><a href="#local-6989586621679040680"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040681"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-280"></a><a name="lookup"><a href="Codec.Archive.Tar.Index.IntTrie.html#lookup"><span class="hs-identifier">lookup</span></a></a><span> </span><a name="local-6989586621679042099"><a href="#local-6989586621679042099"><span class="hs-identifier">trie</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-var">IntTrie</span></a><span> </span><a name="local-6989586621679042100"><a href="#local-6989586621679042100"><span class="hs-identifier">arr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679042101"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-281"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-282"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679040680"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieLookup"><span class="hs-identifier hs-type">TrieLookup</span></a><span> </span><a href="#local-6989586621679040680"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040681"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>    </span><a name="local-6989586621679042101"><a href="#local-6989586621679042101"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679042106"><a href="#local-6989586621679042106"><span class="hs-identifier">nodeOff</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042103"><span class="hs-identifier hs-var">completions</span></a><span> </span><a href="#local-6989586621679042106"><span class="hs-identifier hs-var">nodeOff</span></a><span class="hs-special">)</span><span>
</span><a name="line-284"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679042107"><a href="#local-6989586621679042107"><span class="hs-identifier">nodeOff</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679042108"><a href="#local-6989586621679042108"><span class="hs-identifier">k</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679042109"><a href="#local-6989586621679042109"><span class="hs-identifier">ks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679042104"><span class="hs-identifier hs-var">search</span></a><span> </span><a href="#local-6989586621679042107"><span class="hs-identifier hs-var">nodeOff</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#tagLeaf"><span class="hs-identifier hs-var">tagLeaf</span></a><span> </span><a href="#local-6989586621679042110"><span class="hs-identifier hs-var">k'</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-285"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679042111"><a href="#local-6989586621679042111"><span class="hs-identifier">entryOff</span></a></a><span>
</span><a name="line-286"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679042109"><span class="hs-identifier hs-var">ks</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042102"><span class="hs-identifier hs-var">entry</span></a><span> </span><a href="#local-6989586621679042111"><span class="hs-identifier hs-var">entryOff</span></a><span class="hs-special">)</span><span>
</span><a name="line-287"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-288"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679042104"><span class="hs-identifier hs-var">search</span></a><span> </span><a href="#local-6989586621679042107"><span class="hs-identifier hs-var">nodeOff</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#tagNode"><span class="hs-identifier hs-var">tagNode</span></a><span> </span><a href="#local-6989586621679042110"><span class="hs-identifier hs-var">k'</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-289"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-290"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679042112"><a href="#local-6989586621679042112"><span class="hs-identifier">entryOff</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679042101"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042100"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621679042112"><span class="hs-identifier hs-var">entryOff</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679042109"><span class="hs-identifier hs-var">ks</span></a><span>
</span><a name="line-291"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-292"></a><span>        </span><a name="local-6989586621679042110"><a href="#local-6989586621679042110"><span class="hs-identifier">k'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#enumToWord32"><span class="hs-identifier hs-var">enumToWord32</span></a><span> </span><a href="#local-6989586621679042108"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span>    </span><a name="local-6989586621679042102"><a href="#local-6989586621679042102"><span class="hs-identifier">entry</span></a></a><span>       </span><a name="local-6989586621679042113"><a href="#local-6989586621679042113"><span class="hs-identifier">entryOff</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Entry"><span class="hs-identifier hs-var">Entry</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#word32ToEnum"><span class="hs-identifier hs-var">word32ToEnum</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042100"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621679042113"><span class="hs-identifier hs-var">entryOff</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-295"></a><span>    </span><a name="local-6989586621679042103"><a href="#local-6989586621679042103"><span class="hs-identifier">completions</span></a></a><span> </span><a name="local-6989586621679042114"><a href="#local-6989586621679042114"><span class="hs-identifier">nodeOff</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Completions"><span class="hs-identifier hs-var">Completions</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#completionsFrom"><span class="hs-identifier hs-var">completionsFrom</span></a><span> </span><a href="#local-6989586621679042099"><span class="hs-identifier hs-var">trie</span></a><span> </span><a href="#local-6989586621679042114"><span class="hs-identifier hs-var">nodeOff</span></a><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span>    </span><span class="hs-identifier">search</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Word32</span><span>
</span><a name="line-298"></a><span>    </span><a name="local-6989586621679042104"><a href="#local-6989586621679042104"><span class="hs-identifier">search</span></a></a><span> </span><a name="local-6989586621679042115"><a href="#local-6989586621679042115"><span class="hs-identifier">nodeOff</span></a></a><span> </span><a name="local-6989586621679042116"><a href="#local-6989586621679042116"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><a href="#local-6989586621679042117"><span class="hs-identifier hs-var">nodeSize</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042105"><span class="hs-identifier hs-var">bsearch</span></a><span> </span><a href="#local-6989586621679042118"><span class="hs-identifier hs-var">keysStart</span></a><span> </span><a href="#local-6989586621679042119"><span class="hs-identifier hs-var">keysEnd</span></a><span> </span><a href="#local-6989586621679042116"><span class="hs-identifier hs-var">key</span></a><span class="hs-special">)</span><span>
</span><a name="line-299"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-300"></a><span>        </span><a name="local-6989586621679042117"><a href="#local-6989586621679042117"><span class="hs-identifier">nodeSize</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679042100"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621679042115"><span class="hs-identifier hs-var">nodeOff</span></a><span>
</span><a name="line-301"></a><span>        </span><a name="local-6989586621679042118"><a href="#local-6989586621679042118"><span class="hs-identifier">keysStart</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679042115"><span class="hs-identifier hs-var">nodeOff</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-302"></a><span>        </span><a name="local-6989586621679042119"><a href="#local-6989586621679042119"><span class="hs-identifier">keysEnd</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679042115"><span class="hs-identifier hs-var">nodeOff</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679042117"><span class="hs-identifier hs-var">nodeSize</span></a><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span>    </span><span class="hs-identifier">bsearch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Word32</span><span>
</span><a name="line-305"></a><span>    </span><a name="local-6989586621679042105"><a href="#local-6989586621679042105"><span class="hs-identifier">bsearch</span></a></a><span> </span><a name="local-6989586621679042120"><a href="#local-6989586621679042120"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679042121"><a href="#local-6989586621679042121"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679042122"><a href="#local-6989586621679042122"><span class="hs-identifier">key</span></a></a><span>
</span><a name="line-306"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679042120"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679042121"><span class="hs-identifier hs-var">b</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-307"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">compare</span><span> </span><a href="#local-6989586621679042122"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042100"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621679042123"><span class="hs-identifier hs-var">mid</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-308"></a><span>          </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679042105"><span class="hs-identifier hs-var">bsearch</span></a><span> </span><a href="#local-6989586621679042120"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042123"><span class="hs-identifier hs-var">mid</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679042122"><span class="hs-identifier hs-var">key</span></a><span>
</span><a name="line-309"></a><span>          </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679042123"><span class="hs-identifier hs-var">mid</span></a><span>
</span><a name="line-310"></a><span>          </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679042105"><span class="hs-identifier hs-var">bsearch</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042123"><span class="hs-identifier hs-var">mid</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679042121"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679042122"><span class="hs-identifier hs-var">key</span></a><span>
</span><a name="line-311"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679042123"><a href="#local-6989586621679042123"><span class="hs-identifier">mid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042120"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679042121"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">div</span><span class="hs-special">`</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-312"></a><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span class="hs-identifier">enumToWord32</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040679"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679040679"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word32</span><span>
</span><a name="line-315"></a><a name="enumToWord32"><a href="Codec.Archive.Tar.Index.IntTrie.html#enumToWord32"><span class="hs-identifier">enumToWord32</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromEnum</span><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span class="hs-identifier">word32ToEnum</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040678"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679040678"><span class="hs-identifier hs-type">n</span></a><span>
</span><a name="line-318"></a><a name="word32ToEnum"><a href="Codec.Archive.Tar.Index.IntTrie.html#word32ToEnum"><span class="hs-identifier">word32ToEnum</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toEnum</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-322"></a><span class="hs-comment">-- Building Tries</span><span>
</span><a name="line-323"></a><span class="hs-comment">--</span><span>
</span><a name="line-324"></a><span>
</span><a name="line-325"></a><span class="hs-keyword">newtype</span><span> </span><a name="IntTrieBuilder"><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier">IntTrieBuilder</span></a></a><span> </span><a name="local-6989586621679038200"><a href="#local-6989586621679038200"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679038201"><a href="#local-6989586621679038201"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="IntTrieBuilder"><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier">IntTrieBuilder</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieNode"><span class="hs-identifier hs-type">TrieNode</span></a><span> </span><a href="#local-6989586621679038200"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679038201"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-326"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span class="hs-keyword">data</span><span> </span><a name="TrieNode"><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieNode"><span class="hs-identifier">TrieNode</span></a></a><span> </span><a name="local-6989586621679032752"><a href="#local-6989586621679032752"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679032753"><a href="#local-6989586621679032753"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TrieLeaf"><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieLeaf"><span class="hs-identifier">TrieLeaf</span></a></a><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Word32</span><span>
</span><a name="line-329"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><a name="TrieNode"><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieNode"><span class="hs-identifier">TrieNode</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679032752"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679032753"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-331"></a><span>
</span><a name="line-332"></a><span class="hs-identifier">empty</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679040676"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040677"><span class="hs-identifier hs-type">v</span></a><span>
</span><a name="line-333"></a><a name="empty"><a href="Codec.Archive.Tar.Index.IntTrie.html#empty"><span class="hs-identifier">empty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-var">IntTrieBuilder</span></a><span> </span><span class="hs-identifier hs-var">IntMap.empty</span><span>
</span><a name="line-334"></a><span>
</span><a name="line-335"></a><span class="hs-identifier">insert</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040674"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040675"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679040674"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679040675"><span class="hs-identifier hs-type">v</span></a><span>
</span><a name="line-336"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679040674"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040675"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679040674"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040675"><span class="hs-identifier hs-type">v</span></a><span>
</span><a name="line-337"></a><a name="insert"><a href="Codec.Archive.Tar.Index.IntTrie.html#insert"><span class="hs-identifier">insert</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><a name="local-6989586621679042633"><a href="#local-6989586621679042633"><span class="hs-identifier">_v</span></a></a><span> </span><a name="local-6989586621679042634"><a href="#local-6989586621679042634"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679042634"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-338"></a><span class="hs-identifier">insert</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679042635"><a href="#local-6989586621679042635"><span class="hs-identifier">k</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679042636"><a href="#local-6989586621679042636"><span class="hs-identifier">ks</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679042637"><a href="#local-6989586621679042637"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621679042638"><a href="#local-6989586621679042638"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#insertTrie"><span class="hs-identifier hs-var">insertTrie</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromEnum</span><span> </span><a href="#local-6989586621679042635"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fromEnum</span><span> </span><a href="#local-6989586621679042636"><span class="hs-identifier hs-var">ks</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#enumToWord32"><span class="hs-identifier hs-var">enumToWord32</span></a><span> </span><a href="#local-6989586621679042637"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679042638"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span class="hs-identifier">insertTrie</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word32</span><span>
</span><a name="line-341"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679040672"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040673"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679040672"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040673"><span class="hs-identifier hs-type">v</span></a><span>
</span><a name="line-342"></a><a name="insertTrie"><a href="Codec.Archive.Tar.Index.IntTrie.html#insertTrie"><span class="hs-identifier">insertTrie</span></a></a><span> </span><a name="local-6989586621679042639"><a href="#local-6989586621679042639"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679042640"><a href="#local-6989586621679042640"><span class="hs-identifier">ks</span></a></a><span> </span><a name="local-6989586621679042641"><a href="#local-6989586621679042641"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-var">IntTrieBuilder</span></a><span> </span><a name="local-6989586621679042642"><a href="#local-6989586621679042642"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-343"></a><span>    </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-var">IntTrieBuilder</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-344"></a><span>      </span><span class="hs-identifier hs-var">IntMap.alter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679042643"><a href="#local-6989586621679042643"><span class="hs-identifier">t'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#freshTrieNode"><span class="hs-identifier hs-var">freshTrieNode</span></a><span>  </span><a href="#local-6989586621679042640"><span class="hs-identifier hs-var">ks</span></a><span> </span><a href="#local-6989586621679042641"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span>                                         </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#insertTrieNode"><span class="hs-identifier hs-var">insertTrieNode</span></a><span> </span><a href="#local-6989586621679042640"><span class="hs-identifier hs-var">ks</span></a><span> </span><a href="#local-6989586621679042641"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679042643"><span class="hs-identifier hs-var">t'</span></a><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span>                   </span><a href="#local-6989586621679042639"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679042642"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span class="hs-identifier">insertTrieNode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieNode"><span class="hs-identifier hs-type">TrieNode</span></a><span> </span><a href="#local-6989586621679040670"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040671"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieNode"><span class="hs-identifier hs-type">TrieNode</span></a><span> </span><a href="#local-6989586621679040670"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040671"><span class="hs-identifier hs-type">v</span></a><span>
</span><a name="line-349"></a><a name="insertTrieNode"><a href="Codec.Archive.Tar.Index.IntTrie.html#insertTrieNode"><span class="hs-identifier">insertTrieNode</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><a name="local-6989586621679042668"><a href="#local-6989586621679042668"><span class="hs-identifier">v</span></a></a><span>  </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieLeaf"><span class="hs-identifier hs-var">TrieLeaf</span></a><span> </span><a href="#local-6989586621679042668"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-350"></a><span class="hs-identifier">insertTrieNode</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679042669"><a href="#local-6989586621679042669"><span class="hs-identifier">k</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679042670"><a href="#local-6989586621679042670"><span class="hs-identifier">ks</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679042671"><a href="#local-6989586621679042671"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieLeaf"><span class="hs-identifier hs-var">TrieLeaf</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieNode"><span class="hs-identifier hs-var">TrieNode</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#freshTrie"><span class="hs-identifier hs-var">freshTrie</span></a><span>  </span><a href="#local-6989586621679042669"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679042670"><span class="hs-identifier hs-var">ks</span></a><span> </span><a href="#local-6989586621679042671"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span class="hs-identifier">insertTrieNode</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679042672"><a href="#local-6989586621679042672"><span class="hs-identifier">k</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679042673"><a href="#local-6989586621679042673"><span class="hs-identifier">ks</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679042674"><a href="#local-6989586621679042674"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieNode"><span class="hs-identifier hs-var">TrieNode</span></a><span> </span><a name="local-6989586621679042675"><a href="#local-6989586621679042675"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieNode"><span class="hs-identifier hs-var">TrieNode</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#insertTrie"><span class="hs-identifier hs-var">insertTrie</span></a><span> </span><a href="#local-6989586621679042672"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679042673"><span class="hs-identifier hs-var">ks</span></a><span> </span><a href="#local-6989586621679042674"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621679042675"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span class="hs-identifier">freshTrie</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679040668"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040669"><span class="hs-identifier hs-type">v</span></a><span>
</span><a name="line-354"></a><a name="freshTrie"><a href="Codec.Archive.Tar.Index.IntTrie.html#freshTrie"><span class="hs-identifier">freshTrie</span></a></a><span> </span><a name="local-6989586621679042676"><a href="#local-6989586621679042676"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>      </span><a name="local-6989586621679042677"><a href="#local-6989586621679042677"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-355"></a><span>  </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-var">IntTrieBuilder</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IntMap.singleton</span><span> </span><a href="#local-6989586621679042676"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieLeaf"><span class="hs-identifier hs-var">TrieLeaf</span></a><span> </span><a href="#local-6989586621679042677"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-356"></a><span class="hs-identifier">freshTrie</span><span> </span><a name="local-6989586621679042678"><a href="#local-6989586621679042678"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679042679"><a href="#local-6989586621679042679"><span class="hs-identifier">k'</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679042680"><a href="#local-6989586621679042680"><span class="hs-identifier">ks</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679042681"><a href="#local-6989586621679042681"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-357"></a><span>  </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-var">IntTrieBuilder</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IntMap.singleton</span><span> </span><a href="#local-6989586621679042678"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieNode"><span class="hs-identifier hs-var">TrieNode</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#freshTrie"><span class="hs-identifier hs-var">freshTrie</span></a><span> </span><a href="#local-6989586621679042679"><span class="hs-identifier hs-var">k'</span></a><span> </span><a href="#local-6989586621679042680"><span class="hs-identifier hs-var">ks</span></a><span> </span><a href="#local-6989586621679042681"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-358"></a><span>
</span><a name="line-359"></a><span class="hs-identifier">freshTrieNode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieNode"><span class="hs-identifier hs-type">TrieNode</span></a><span> </span><a href="#local-6989586621679040666"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040667"><span class="hs-identifier hs-type">v</span></a><span>
</span><a name="line-360"></a><a name="freshTrieNode"><a href="Codec.Archive.Tar.Index.IntTrie.html#freshTrieNode"><span class="hs-identifier">freshTrieNode</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><a name="local-6989586621679042682"><a href="#local-6989586621679042682"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieLeaf"><span class="hs-identifier hs-var">TrieLeaf</span></a><span> </span><a href="#local-6989586621679042682"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-361"></a><span class="hs-identifier">freshTrieNode</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679042683"><a href="#local-6989586621679042683"><span class="hs-identifier">k</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679042684"><a href="#local-6989586621679042684"><span class="hs-identifier">ks</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679042685"><a href="#local-6989586621679042685"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieNode"><span class="hs-identifier hs-var">TrieNode</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#freshTrie"><span class="hs-identifier hs-var">freshTrie</span></a><span> </span><a href="#local-6989586621679042683"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679042684"><span class="hs-identifier hs-var">ks</span></a><span> </span><a href="#local-6989586621679042685"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span class="hs-identifier">inserts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040664"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040665"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621679040664"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679040665"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-364"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679040664"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040665"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679040664"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040665"><span class="hs-identifier hs-type">v</span></a><span>
</span><a name="line-365"></a><a name="inserts"><a href="Codec.Archive.Tar.Index.IntTrie.html#inserts"><span class="hs-identifier">inserts</span></a></a><span> </span><a name="local-6989586621679042686"><a href="#local-6989586621679042686"><span class="hs-identifier">kvs</span></a></a><span> </span><a name="local-6989586621679042687"><a href="#local-6989586621679042687"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679042688"><a href="#local-6989586621679042688"><span class="hs-identifier">t'</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679042689"><a href="#local-6989586621679042689"><span class="hs-identifier">ks</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679042690"><a href="#local-6989586621679042690"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#insert"><span class="hs-identifier hs-var">insert</span></a><span> </span><a href="#local-6989586621679042689"><span class="hs-identifier hs-var">ks</span></a><span> </span><a href="#local-6989586621679042690"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621679042688"><span class="hs-identifier hs-var">t'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679042687"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679042686"><span class="hs-identifier hs-var">kvs</span></a><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span class="hs-identifier">finalise</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679040662"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040663"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-type">IntTrie</span></a><span> </span><a href="#local-6989586621679040662"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040663"><span class="hs-identifier hs-type">v</span></a><span>
</span><a name="line-368"></a><a name="finalise"><a href="Codec.Archive.Tar.Index.IntTrie.html#finalise"><span class="hs-identifier">finalise</span></a></a><span> </span><a name="local-6989586621679042691"><a href="#local-6989586621679042691"><span class="hs-identifier">trie</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-369"></a><span>    </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-var">IntTrie</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-370"></a><span>      </span><span class="hs-identifier hs-var">A.listArray</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#flatTrieLength"><span class="hs-identifier hs-var">flatTrieLength</span></a><span> </span><a href="#local-6989586621679042691"><span class="hs-identifier hs-var">trie</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>                  </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#flattenTrie"><span class="hs-identifier hs-var">flattenTrie</span></a><span> </span><a href="#local-6989586621679042691"><span class="hs-identifier hs-var">trie</span></a><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span class="hs-identifier">unfinalise</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040103"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679040104"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-type">IntTrie</span></a><span> </span><a href="#local-6989586621679040103"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040104"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679040103"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040104"><span class="hs-identifier hs-type">v</span></a><span>
</span><a name="line-374"></a><a name="unfinalise"><a href="Codec.Archive.Tar.Index.IntTrie.html#unfinalise"><span class="hs-identifier">unfinalise</span></a></a><span> </span><a name="local-6989586621679042692"><a href="#local-6989586621679042692"><span class="hs-identifier">trie</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-375"></a><span>    </span><a href="#local-6989586621679042693"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#completionsFrom"><span class="hs-identifier hs-var">completionsFrom</span></a><span> </span><a href="#local-6989586621679042692"><span class="hs-identifier hs-var">trie</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-377"></a><span>    </span><a name="local-6989586621679042693"><a href="#local-6989586621679042693"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679042694"><a href="#local-6989586621679042694"><span class="hs-identifier">kns</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-378"></a><span>      </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-var">IntTrieBuilder</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-379"></a><span>        </span><span class="hs-identifier hs-var">IntMap.fromList</span><span>
</span><a name="line-380"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromEnum</span><span> </span><a href="#local-6989586621679042695"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679042697"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679042695"><a href="#local-6989586621679042695"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679042696"><a href="#local-6989586621679042696"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679042694"><span class="hs-identifier hs-var">kns</span></a><span>
</span><a name="line-382"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679042697"><a href="#local-6989586621679042697"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679042696"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-383"></a><span>                      </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Entry"><span class="hs-identifier hs-var">Entry</span></a><span>       </span><a name="local-6989586621679042698"><a href="#local-6989586621679042698"><span class="hs-identifier">v</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieLeaf"><span class="hs-identifier hs-var">TrieLeaf</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#enumToWord32"><span class="hs-identifier hs-var">enumToWord32</span></a><span> </span><a href="#local-6989586621679042698"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-384"></a><span>                      </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Completions"><span class="hs-identifier hs-var">Completions</span></a><span> </span><a name="local-6989586621679042699"><a href="#local-6989586621679042699"><span class="hs-identifier">kns'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieNode"><span class="hs-identifier hs-var">TrieNode</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042693"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679042699"><span class="hs-identifier hs-var">kns'</span></a><span class="hs-special">)</span><span>
</span><a name="line-385"></a><span>          </span><span class="hs-special">]</span><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span class="hs-comment">---------------------------------</span><span>
</span><a name="line-388"></a><span class="hs-comment">-- Flattening Tries</span><span>
</span><a name="line-389"></a><span class="hs-comment">--</span><span>
</span><a name="line-390"></a><span>
</span><a name="line-391"></a><span class="hs-keyword">type</span><span> </span><a name="Offset"><a href="Codec.Archive.Tar.Index.IntTrie.html#Offset"><span class="hs-identifier">Offset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-392"></a><span>
</span><a name="line-393"></a><span class="hs-identifier">flatTrieLength</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679040101"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040102"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-394"></a><a name="flatTrieLength"><a href="Codec.Archive.Tar.Index.IntTrie.html#flatTrieLength"><span class="hs-identifier">flatTrieLength</span></a></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-var">IntTrieBuilder</span></a><span> </span><a name="local-6989586621679042700"><a href="#local-6989586621679042700"><span class="hs-identifier">tns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-395"></a><span>    </span><span class="hs-number">1</span><span>
</span><a name="line-396"></a><span>  </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">IntMap.size</span><span> </span><a href="#local-6989586621679042700"><span class="hs-identifier hs-var">tns</span></a><span>
</span><a name="line-397"></a><span>  </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">sum</span><span> </span><span class="hs-special">[</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#flatTrieLength"><span class="hs-identifier hs-var">flatTrieLength</span></a><span> </span><a href="#local-6989586621679042701"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieNode"><span class="hs-identifier hs-var">TrieNode</span></a><span> </span><a name="local-6989586621679042701"><a href="#local-6989586621679042701"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">IntMap.elems</span><span> </span><a href="#local-6989586621679042700"><span class="hs-identifier hs-var">tns</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a><span class="hs-comment">-- This is a breadth-first traversal. We keep a list of the tries that we are</span><span>
</span><a name="line-400"></a><span class="hs-comment">-- to write out next. Each of these have an offset allocated to them at the</span><span>
</span><a name="line-401"></a><span class="hs-comment">-- time we put them into the list. We keep a running offset so we know where</span><span>
</span><a name="line-402"></a><span class="hs-comment">-- to allocate next.</span><span>
</span><a name="line-403"></a><span class="hs-comment">--</span><span>
</span><a name="line-404"></a><span class="hs-identifier">flattenTrie</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679040099"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679040100"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Word32</span><span class="hs-special">]</span><span>
</span><a name="line-405"></a><a name="flattenTrie"><a href="Codec.Archive.Tar.Index.IntTrie.html#flattenTrie"><span class="hs-identifier">flattenTrie</span></a></a><span> </span><a name="local-6989586621679042702"><a href="#local-6989586621679042702"><span class="hs-identifier">trie</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679042704"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#queue"><span class="hs-identifier hs-var">queue</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679042702"><span class="hs-identifier hs-var">trie</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042703"><span class="hs-identifier hs-var">size</span></a><span> </span><a href="#local-6989586621679042702"><span class="hs-identifier hs-var">trie</span></a><span class="hs-special">)</span><span>
</span><a name="line-406"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-407"></a><span>    </span><a name="local-6989586621679042703"><a href="#local-6989586621679042703"><span class="hs-identifier">size</span></a></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-var">IntTrieBuilder</span></a><span> </span><a name="local-6989586621679042710"><a href="#local-6989586621679042710"><span class="hs-identifier">tns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">IntMap.size</span><span> </span><a href="#local-6989586621679042710"><span class="hs-identifier hs-var">tns</span></a><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier hs-type">Q</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679042706"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679042707"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Offset"><span class="hs-identifier hs-type">Offset</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Word32</span><span class="hs-special">]</span><span>
</span><a name="line-410"></a><span>    </span><a name="local-6989586621679042704"><a href="#local-6989586621679042704"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679042711"><a href="#local-6989586621679042711"><span class="hs-identifier">todo</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679042712"><a href="#local-6989586621679042712"><span class="hs-identifier">offset</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-411"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#dequeue"><span class="hs-identifier hs-var">dequeue</span></a><span> </span><a href="#local-6989586621679042711"><span class="hs-identifier hs-var">todo</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-412"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-413"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-var">IntTrieBuilder</span></a><span> </span><a name="local-6989586621679042713"><a href="#local-6989586621679042713"><span class="hs-identifier">tnodes</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679042714"><a href="#local-6989586621679042714"><span class="hs-identifier">tries</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-414"></a><span>            </span><a href="#local-6989586621679042716"><span class="hs-identifier hs-var">flat</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679042704"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679042719"><span class="hs-identifier hs-var">tries'</span></a><span> </span><a href="#local-6989586621679042717"><span class="hs-identifier hs-var">offset'</span></a><span>
</span><a name="line-415"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-416"></a><span>            </span><span class="hs-glyph">!</span><a name="local-6989586621679042715"><a href="#local-6989586621679042715"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IntMap.size</span><span> </span><a href="#local-6989586621679042713"><span class="hs-identifier hs-var">tnodes</span></a><span>
</span><a name="line-417"></a><span>            </span><a name="local-6989586621679042716"><a href="#local-6989586621679042716"><span class="hs-identifier">flat</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679042715"><span class="hs-identifier hs-var">count</span></a><span>
</span><a name="line-418"></a><span>                   </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">Map.keys</span><span>  </span><a href="#local-6989586621679042718"><span class="hs-identifier hs-var">keysValues</span></a><span>
</span><a name="line-419"></a><span>                  </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">Map.elems</span><span> </span><a href="#local-6989586621679042718"><span class="hs-identifier hs-var">keysValues</span></a><span>
</span><a name="line-420"></a><span>            </span><span class="hs-special">(</span><span class="hs-glyph">!</span><a name="local-6989586621679042717"><a href="#local-6989586621679042717"><span class="hs-identifier">offset'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679042718"><a href="#local-6989586621679042718"><span class="hs-identifier">keysValues</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679042719"><a href="#local-6989586621679042719"><span class="hs-identifier">tries'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-421"></a><span class="hs-cpp">#if MIN_VERSION_containers(0,4,2)
</span><span>              </span><span class="hs-identifier hs-var">IntMap.foldlWithKey'</span><span> </span><a href="#local-6989586621679042705"><span class="hs-identifier hs-var">accumNodes</span></a><span>
</span><a name="line-423"></a><span>                                   </span><span class="hs-special">(</span><a href="#local-6989586621679042712"><span class="hs-identifier hs-var">offset</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679042714"><span class="hs-identifier hs-var">tries</span></a><span class="hs-special">)</span><span>
</span><a name="line-424"></a><span>                                   </span><a href="#local-6989586621679042713"><span class="hs-identifier hs-var">tnodes</span></a><span>
</span><a name="line-425"></a><span class="hs-cpp">#else
</span><span>              </span><span class="hs-identifier">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">a</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">k</span><span class="hs-special">,</span><span class="hs-identifier">v</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">accumNodes</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">)</span><span>
</span><a name="line-427"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier">offset</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Map.empty</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tries</span><span class="hs-special">)</span><span>
</span><a name="line-428"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier">IntMap.toList</span><span> </span><span class="hs-identifier">tnodes</span><span class="hs-special">)</span><span>
</span><a name="line-429"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-431"></a><span>    </span><span class="hs-identifier">accumNodes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#Offset"><span class="hs-identifier hs-type">Offset</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Map.Map</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-identifier hs-type">Word32</span><span class="hs-special">,</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier hs-type">Q</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679042708"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679042709"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-432"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieNode"><span class="hs-identifier hs-type">TrieNode</span></a><span> </span><a href="#local-6989586621679042708"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679042709"><span class="hs-identifier hs-type">v</span></a><span>
</span><a name="line-433"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#Offset"><span class="hs-identifier hs-type">Offset</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Map.Map</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-identifier hs-type">Word32</span><span class="hs-special">,</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier hs-type">Q</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrieBuilder"><span class="hs-identifier hs-type">IntTrieBuilder</span></a><span> </span><a href="#local-6989586621679042708"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679042709"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-434"></a><span>    </span><a name="local-6989586621679042705"><a href="#local-6989586621679042705"><span class="hs-identifier">accumNodes</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><a name="local-6989586621679042720"><a href="#local-6989586621679042720"><span class="hs-identifier">off</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679042721"><a href="#local-6989586621679042721"><span class="hs-identifier">kvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679042722"><a href="#local-6989586621679042722"><span class="hs-identifier">tries</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679042723"><a href="#local-6989586621679042723"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieLeaf"><span class="hs-identifier hs-var">TrieLeaf</span></a><span> </span><a name="local-6989586621679042724"><a href="#local-6989586621679042724"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-435"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621679042720"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679042725"><span class="hs-identifier hs-var">kvs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679042722"><span class="hs-identifier hs-var">tries</span></a><span class="hs-special">)</span><span>
</span><a name="line-436"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-437"></a><span>        </span><a name="local-6989586621679042725"><a href="#local-6989586621679042725"><span class="hs-identifier">kvs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#tagLeaf"><span class="hs-identifier hs-var">tagLeaf</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#int2Word32"><span class="hs-identifier hs-var">int2Word32</span></a><span> </span><a href="#local-6989586621679042723"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679042724"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621679042721"><span class="hs-identifier hs-var">kvs</span></a><span>
</span><a name="line-438"></a><span>
</span><a name="line-439"></a><span>    </span><span class="hs-identifier">accumNodes</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><a name="local-6989586621679042833"><a href="#local-6989586621679042833"><span class="hs-identifier">off</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679042834"><a href="#local-6989586621679042834"><span class="hs-identifier">kvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679042835"><a href="#local-6989586621679042835"><span class="hs-identifier">tries</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679042836"><a href="#local-6989586621679042836"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#TrieNode"><span class="hs-identifier hs-var">TrieNode</span></a><span> </span><a name="local-6989586621679042837"><a href="#local-6989586621679042837"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-440"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621679042833"><span class="hs-identifier hs-var">off</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679042703"><span class="hs-identifier hs-var">size</span></a><span> </span><a href="#local-6989586621679042837"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679042838"><span class="hs-identifier hs-var">kvs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679042839"><span class="hs-identifier hs-var">tries'</span></a><span class="hs-special">)</span><span>
</span><a name="line-441"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-442"></a><span>        </span><a name="local-6989586621679042838"><a href="#local-6989586621679042838"><span class="hs-identifier">kvs'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#tagNode"><span class="hs-identifier hs-var">tagNode</span></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#int2Word32"><span class="hs-identifier hs-var">int2Word32</span></a><span> </span><a href="#local-6989586621679042836"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#int2Word32"><span class="hs-identifier hs-var">int2Word32</span></a><span> </span><a href="#local-6989586621679042833"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679042834"><span class="hs-identifier hs-var">kvs</span></a><span>
</span><a name="line-443"></a><span>        </span><a name="local-6989586621679042839"><a href="#local-6989586621679042839"><span class="hs-identifier">tries'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#enqueue"><span class="hs-identifier hs-var">enqueue</span></a><span> </span><a href="#local-6989586621679042835"><span class="hs-identifier hs-var">tries</span></a><span> </span><a href="#local-6989586621679042837"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-444"></a><span>
</span><a name="line-445"></a><span class="hs-keyword">data</span><span> </span><a name="Q"><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier">Q</span></a></a><span> </span><a name="local-6989586621679032751"><a href="#local-6989586621679032751"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Q"><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier">Q</span></a></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679032751"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679032751"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-446"></a><span>
</span><a name="line-447"></a><span class="hs-identifier">queue</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679040098"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier hs-type">Q</span></a><span> </span><a href="#local-6989586621679040098"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-448"></a><a name="queue"><a href="Codec.Archive.Tar.Index.IntTrie.html#queue"><span class="hs-identifier">queue</span></a></a><span> </span><a name="local-6989586621679042840"><a href="#local-6989586621679042840"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier hs-var">Q</span></a><span> </span><a href="#local-6989586621679042840"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span class="hs-identifier">enqueue</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier hs-type">Q</span></a><span> </span><a href="#local-6989586621679040097"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679040097"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier hs-type">Q</span></a><span> </span><a href="#local-6989586621679040097"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-451"></a><a name="enqueue"><a href="Codec.Archive.Tar.Index.IntTrie.html#enqueue"><span class="hs-identifier">enqueue</span></a></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier hs-var">Q</span></a><span> </span><a name="local-6989586621679042841"><a href="#local-6989586621679042841"><span class="hs-identifier">front</span></a></a><span>  </span><a name="local-6989586621679042842"><a href="#local-6989586621679042842"><span class="hs-identifier">back</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679042843"><a href="#local-6989586621679042843"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier hs-var">Q</span></a><span> </span><a href="#local-6989586621679042841"><span class="hs-identifier hs-var">front</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042843"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679042842"><span class="hs-identifier hs-var">back</span></a><span class="hs-special">)</span><span>
</span><a name="line-452"></a><span>
</span><a name="line-453"></a><span class="hs-identifier">dequeue</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier hs-type">Q</span></a><span> </span><a href="#local-6989586621679040096"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679040096"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier hs-type">Q</span></a><span> </span><a href="#local-6989586621679040096"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-454"></a><a name="dequeue"><a href="Codec.Archive.Tar.Index.IntTrie.html#dequeue"><span class="hs-identifier">dequeue</span></a></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier hs-var">Q</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679042844"><a href="#local-6989586621679042844"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679042845"><a href="#local-6989586621679042845"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679042846"><a href="#local-6989586621679042846"><span class="hs-identifier">back</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042844"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier hs-var">Q</span></a><span> </span><a href="#local-6989586621679042845"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621679042846"><span class="hs-identifier hs-var">back</span></a><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span class="hs-identifier">dequeue</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier hs-var">Q</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><a name="local-6989586621679042847"><a href="#local-6989586621679042847"><span class="hs-identifier">back</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621679042847"><span class="hs-identifier hs-var">back</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-456"></a><span>                               </span><a name="local-6989586621679042848"><a href="#local-6989586621679042848"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679042849"><a href="#local-6989586621679042849"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042848"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#Q"><span class="hs-identifier hs-var">Q</span></a><span> </span><a href="#local-6989586621679042849"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-457"></a><span>                               </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span class="hs-identifier">int2Word32</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word32</span><span>
</span><a name="line-460"></a><a name="int2Word32"><a href="Codec.Archive.Tar.Index.IntTrie.html#int2Word32"><span class="hs-identifier">int2Word32</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span>
</span><a name="line-461"></a><span>
</span><a name="line-462"></a><span>
</span><a name="line-463"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-464"></a><span class="hs-comment">-- (de)serialisation</span><span>
</span><a name="line-465"></a><span class="hs-comment">--</span><span>
</span><a name="line-466"></a><span>
</span><a name="line-467"></a><span class="hs-identifier">serialise</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-type">IntTrie</span></a><span> </span><a href="#local-6989586621679039857"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679039858"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BS.Builder</span><span>
</span><a name="line-468"></a><a name="serialise"><a href="Codec.Archive.Tar.Index.IntTrie.html#serialise"><span class="hs-identifier">serialise</span></a></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-var">IntTrie</span></a><span> </span><a name="local-6989586621679042850"><a href="#local-6989586621679042850"><span class="hs-identifier">arr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-469"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679042851"><a href="#local-6989586621679042851"><span class="hs-identifier">ixEnd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">A.bounds</span><span> </span><a href="#local-6989586621679042850"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-470"></a><span>    </span><span class="hs-identifier hs-var">BS.word32BE</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042851"><span class="hs-identifier hs-var">ixEnd</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-471"></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679042852"><a href="#local-6989586621679042852"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679042853"><a href="#local-6989586621679042853"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">BS.word32BE</span><span> </span><a href="#local-6989586621679042852"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679042853"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">mempty</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">A.elems</span><span> </span><a href="#local-6989586621679042850"><span class="hs-identifier hs-var">arr</span></a><span class="hs-special">)</span><span>
</span><a name="line-472"></a><span>
</span><a name="line-473"></a><span class="hs-identifier">serialiseSize</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-type">IntTrie</span></a><span> </span><a href="#local-6989586621679039855"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679039856"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-474"></a><a name="serialiseSize"><a href="Codec.Archive.Tar.Index.IntTrie.html#serialiseSize"><span class="hs-identifier">serialiseSize</span></a></a><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-var">IntTrie</span></a><span> </span><a name="local-6989586621679042854"><a href="#local-6989586621679042854"><span class="hs-identifier">arr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-475"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679042855"><a href="#local-6989586621679042855"><span class="hs-identifier">ixEnd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">A.bounds</span><span> </span><a href="#local-6989586621679042854"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-476"></a><span>    </span><span class="hs-number">4</span><span>
</span><a name="line-477"></a><span>  </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679042855"><span class="hs-identifier hs-var">ixEnd</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-478"></a><span>
</span><a name="line-479"></a><span class="hs-identifier">deserialise</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">BS.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-type">IntTrie</span></a><span> </span><a href="#local-6989586621679039810"><span class="hs-identifier hs-type">k</span></a><span> </span><a href="#local-6989586621679039811"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">BS.ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-480"></a><a name="deserialise"><a href="Codec.Archive.Tar.Index.IntTrie.html#deserialise"><span class="hs-identifier">deserialise</span></a></a><span> </span><a name="local-6989586621679042856"><a href="#local-6989586621679042856"><span class="hs-identifier">bs</span></a></a><span>
</span><a name="line-481"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">BS.length</span><span> </span><a href="#local-6989586621679042856"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">4</span><span>
</span><a name="line-482"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679042857"><a href="#local-6989586621679042857"><span class="hs-identifier">lenArr</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#readWord32BE"><span class="hs-identifier hs-var">readWord32BE</span></a><span> </span><a href="#local-6989586621679042856"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-483"></a><span>        </span><a name="local-6989586621679042858"><a href="#local-6989586621679042858"><span class="hs-identifier">lenTotal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679042857"><span class="hs-identifier hs-var">lenArr</span></a><span>
</span><a name="line-484"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">BS.length</span><span> </span><a href="#local-6989586621679042856"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679042857"><span class="hs-identifier hs-var">lenArr</span></a><span>
</span><a name="line-485"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621679042859"><a href="#local-6989586621679042859"><span class="hs-identifier">arr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">A.array</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679042857"><span class="hs-identifier hs-var">lenArr</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-486"></a><span>                      </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042861"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">,</span><span> </span><a href="Codec.Archive.Tar.Index.IntTrie.html#readWord32BE"><span class="hs-identifier hs-var">readWord32BE</span></a><span> </span><a href="#local-6989586621679042856"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621679042862"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span>
</span><a name="line-487"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679042861"><a href="#local-6989586621679042861"><span class="hs-identifier">i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679042862"><a href="#local-6989586621679042862"><span class="hs-identifier">off</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><a href="#local-6989586621679042857"><span class="hs-identifier hs-var">lenArr</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-number">4</span><span class="hs-special">,</span><span class="hs-number">8</span><span> </span><span class="hs-glyph">..</span><span> </span><a href="#local-6989586621679042858"><span class="hs-identifier hs-var">lenTotal</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">4</span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-488"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621679042860"><a href="#local-6989586621679042860"><span class="hs-identifier">bs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BS.drop</span><span> </span><a href="#local-6989586621679042858"><span class="hs-identifier hs-var">lenTotal</span></a><span> </span><a href="#local-6989586621679042856"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-489"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Codec.Archive.Tar.Index.IntTrie.html#IntTrie"><span class="hs-identifier hs-var">IntTrie</span></a><span> </span><a href="#local-6989586621679042859"><span class="hs-identifier hs-var">arr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679042860"><span class="hs-identifier hs-var">bs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-492"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-493"></a><span>
</span><a name="line-494"></a><span class="hs-identifier">readWord32BE</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">BS.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word32</span><span>
</span><a name="line-495"></a><a name="readWord32BE"><a href="Codec.Archive.Tar.Index.IntTrie.html#readWord32BE"><span class="hs-identifier">readWord32BE</span></a></a><span> </span><a name="local-6989586621679042863"><a href="#local-6989586621679042863"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621679042864"><a href="#local-6989586621679042864"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-496"></a><span>    </span><span class="hs-identifier hs-var">assert</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042864"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621679042864"><span class="hs-identifier hs-var">i</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-identifier hs-var">BS.length</span><span> </span><a href="#local-6989586621679042863"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-497"></a><span>    </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS.unsafeIndex</span><span> </span><a href="#local-6989586621679042863"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042864"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftL</span><span class="hs-special">`</span><span> </span><span class="hs-number">24</span><span>
</span><a name="line-498"></a><span>  </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS.unsafeIndex</span><span> </span><a href="#local-6989586621679042863"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042864"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftL</span><span class="hs-special">`</span><span> </span><span class="hs-number">16</span><span>
</span><a name="line-499"></a><span>  </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS.unsafeIndex</span><span> </span><a href="#local-6989586621679042863"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042864"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftL</span><span class="hs-special">`</span><span> </span><span class="hs-number">8</span><span>
</span><a name="line-500"></a><span>  </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS.unsafeIndex</span><span> </span><a href="#local-6989586621679042863"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679042864"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">3</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-501"></a><span>
</span><a name="line-502"></a><span>
</span><a name="line-503"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-504"></a><span class="hs-comment">-- Correctness property</span><span>
</span><a name="line-505"></a><span class="hs-comment">--</span><span>
</span><a name="line-506"></a><span>
</span><a name="line-507"></a><span class="hs-cpp">#ifdef TESTS
</span><span>
</span><a name="line-509"></a><span class="hs-identifier">prop_lookup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ord</span><span> </span><span class="hs-identifier">k</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Enum</span><span> </span><span class="hs-identifier">k</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Eq</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Enum</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">k</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Show</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier">k</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><a name="line-511"></a><span class="hs-identifier">prop_lookup</span><span> </span><span class="hs-identifier">paths</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-512"></a><span>  </span><span class="hs-identifier">flip</span><span> </span><span class="hs-identifier">all</span><span> </span><span class="hs-identifier">paths</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">key</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">value</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-513"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">lookup</span><span> </span><span class="hs-identifier">trie</span><span> </span><span class="hs-identifier">key</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-514"></a><span>      </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Entry</span><span> </span><span class="hs-identifier">value'</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">value'</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">value</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">True</span><span>
</span><a name="line-515"></a><span>      </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Entry</span><span> </span><span class="hs-identifier">value'</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">error</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-string">&quot;IntTrie: &quot;</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">key</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">value</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">value'</span><span class="hs-special">)</span><span>
</span><a name="line-516"></a><span>      </span><span class="hs-identifier">Nothing</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">error</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-string">&quot;IntTrie: didn't find &quot;</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">key</span><span>
</span><a name="line-517"></a><span>      </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Completions</span><span> </span><span class="hs-identifier">xs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">error</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-string">&quot;IntTrie: &quot;</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">xs</span><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-520"></a><span>    </span><span class="hs-identifier">trie</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">construct</span><span> </span><span class="hs-identifier">paths</span><span>
</span><a name="line-521"></a><span>
</span><a name="line-522"></a><span class="hs-identifier">prop_completions</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">v</span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ord</span><span> </span><span class="hs-identifier">k</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Enum</span><span> </span><span class="hs-identifier">k</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Eq</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Enum</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier">k</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">v</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><a name="line-523"></a><span class="hs-identifier">prop_completions</span><span> </span><span class="hs-identifier">paths</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-524"></a><span>    </span><span class="hs-identifier">inserts</span><span> </span><span class="hs-identifier">paths</span><span> </span><span class="hs-identifier">empty</span><span>
</span><a name="line-525"></a><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">convertCompletions</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">completionsFrom</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">construct</span><span> </span><span class="hs-identifier">paths</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-526"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-527"></a><span>    </span><span class="hs-identifier">convertCompletions</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ord</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">Completions</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IntTrieBuilder</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">v</span><span>
</span><a name="line-528"></a><span>    </span><span class="hs-identifier">convertCompletions</span><span> </span><span class="hs-identifier">kls</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-529"></a><span>      </span><span class="hs-identifier">IntTrieBuilder</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-530"></a><span>        </span><span class="hs-identifier">IntMap.fromList</span><span>
</span><a name="line-531"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">l</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-532"></a><span>              </span><span class="hs-identifier">Entry</span><span> </span><span class="hs-identifier">v</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">mkleaf</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">v</span><span>
</span><a name="line-533"></a><span>              </span><span class="hs-identifier">Completions</span><span> </span><span class="hs-identifier">kls'</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">mknode</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">convertCompletions</span><span> </span><span class="hs-identifier">kls'</span><span class="hs-special">)</span><span>
</span><a name="line-534"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">k</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">l</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">compare</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">fst</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">kls</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-535"></a><span>
</span><a name="line-536"></a><span>
</span><a name="line-537"></a><span class="hs-identifier">prop_lookup_mono</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><a name="line-538"></a><span class="hs-identifier">prop_lookup_mono</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-identifier">paths</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">prop_lookup</span><span> </span><span class="hs-identifier">paths</span><span>
</span><a name="line-539"></a><span>
</span><a name="line-540"></a><span class="hs-identifier">prop_completions_mono</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><a name="line-541"></a><span class="hs-identifier">prop_completions_mono</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-identifier">paths</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">prop_completions</span><span> </span><span class="hs-identifier">paths</span><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span class="hs-identifier">prop_construct_toList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><a name="line-544"></a><span class="hs-identifier">prop_construct_toList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-identifier">paths</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-545"></a><span>       </span><span class="hs-identifier">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">compare</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">fst</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">toList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">construct</span><span> </span><span class="hs-identifier">paths</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-546"></a><span>    </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">compare</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">fst</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">paths</span><span>
</span><a name="line-547"></a><span>
</span><a name="line-548"></a><span class="hs-identifier">prop_finalise_unfinalise</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><a name="line-549"></a><span class="hs-identifier">prop_finalise_unfinalise</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-identifier">paths</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-550"></a><span>    </span><span class="hs-identifier">builder</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">unfinalise</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">finalise</span><span> </span><span class="hs-identifier">builder</span><span class="hs-special">)</span><span>
</span><a name="line-551"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-552"></a><span>    </span><span class="hs-identifier">builder</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IntTrieBuilder</span><span> </span><span class="hs-identifier">Char</span><span> </span><span class="hs-identifier">Char</span><span>
</span><a name="line-553"></a><span>    </span><span class="hs-identifier">builder</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inserts</span><span> </span><span class="hs-identifier">paths</span><span> </span><span class="hs-identifier">empty</span><span>
</span><a name="line-554"></a><span>
</span><a name="line-555"></a><span class="hs-identifier">prop_serialise_deserialise</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><a name="line-556"></a><span class="hs-identifier">prop_serialise_deserialise</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-identifier">paths</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-557"></a><span>    </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">trie</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">BS.empty</span><span class="hs-special">)</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">deserialise</span><span>
</span><a name="line-558"></a><span>                            </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">toStrict</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">BS.toLazyByteString</span><span>
</span><a name="line-559"></a><span>                            </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">serialise</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">trie</span><span>
</span><a name="line-560"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-561"></a><span>    </span><span class="hs-identifier">trie</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IntTrie</span><span> </span><span class="hs-identifier">Char</span><span> </span><span class="hs-identifier">Char</span><span>
</span><a name="line-562"></a><span>    </span><span class="hs-identifier">trie</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">construct</span><span> </span><span class="hs-identifier">paths</span><span>
</span><a name="line-563"></a><span>
</span><a name="line-564"></a><span class="hs-identifier">prop_serialiseSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span>
</span><a name="line-565"></a><span class="hs-identifier">prop_serialiseSize</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-identifier">paths</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-566"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">LBS.length</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">BS.toLazyByteString</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">serialise</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">trie</span><span>
</span><a name="line-567"></a><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">serialiseSize</span><span> </span><span class="hs-identifier">trie</span><span>
</span><a name="line-568"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-569"></a><span>    </span><span class="hs-identifier">trie</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IntTrie</span><span> </span><span class="hs-identifier">Char</span><span> </span><span class="hs-identifier">Char</span><span>
</span><a name="line-570"></a><span>    </span><span class="hs-identifier">trie</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">construct</span><span> </span><span class="hs-identifier">paths</span><span>
</span><a name="line-571"></a><span>
</span><a name="line-572"></a><span class="hs-keyword">newtype</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier">Char</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Char</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier">Show</span><span>
</span><a name="line-573"></a><span>
</span><a name="line-574"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">Arbitrary</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-575"></a><span>  </span><span class="hs-identifier">arbitrary</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-576"></a><span>      </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">makeNoPrefix</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">listOf</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">listOf1</span><span> </span><span class="hs-identifier">arbitrary</span><span> </span><span class="hs-operator">&lt;*&gt;</span><span> </span><span class="hs-identifier">arbitrary</span><span class="hs-special">)</span><span>
</span><a name="line-577"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-578"></a><span>      </span><span class="hs-identifier">makeNoPrefix</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-579"></a><span>      </span><span class="hs-identifier">makeNoPrefix</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">k</span><span class="hs-special">,</span><span class="hs-identifier">v</span><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-identifier">kvs</span><span class="hs-special">)</span><span>
</span><a name="line-580"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">all</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">k'</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isPrefixOfOther</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">k'</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">kvs</span><span>
</span><a name="line-581"></a><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">k</span><span class="hs-special">,</span><span class="hs-identifier">v</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">makeNoPrefix</span><span> </span><span class="hs-identifier">kvs</span><span>
</span><a name="line-582"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span>  </span><span class="hs-glyph">=</span><span>         </span><span class="hs-identifier">makeNoPrefix</span><span> </span><span class="hs-identifier">kvs</span><span>
</span><a name="line-583"></a><span>
</span><a name="line-584"></a><span>  </span><span class="hs-identifier">shrink</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-identifier">kvs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-585"></a><span>      </span><span class="hs-identifier">map</span><span> </span><span class="hs-identifier">ValidPaths</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">filter</span><span> </span><span class="hs-identifier">noPrefix</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">filter</span><span> </span><span class="hs-identifier">nonEmpty</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">shrink</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">kvs</span><span>
</span><a name="line-586"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-587"></a><span>      </span><span class="hs-identifier">noPrefix</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">True</span><span>
</span><a name="line-588"></a><span>      </span><span class="hs-identifier">noPrefix</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">k</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-identifier">kvs'</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">all</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">k'</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isPrefixOfOther</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">k'</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">kvs'</span><span>
</span><a name="line-589"></a><span>                           </span><span class="hs-operator">&amp;&amp;</span><span> </span><span class="hs-identifier">noPrefix</span><span> </span><span class="hs-identifier">kvs'</span><span>
</span><a name="line-590"></a><span>      </span><span class="hs-identifier">nonEmpty</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">not</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">null</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">fst</span><span class="hs-special">)</span><span>
</span><a name="line-591"></a><span>
</span><a name="line-592"></a><span class="hs-identifier">isPrefixOfOther</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-identifier">b</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">isPrefixOf</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">b</span><span> </span><span class="hs-operator">||</span><span> </span><span class="hs-identifier">b</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">isPrefixOf</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">a</span><span>
</span><a name="line-593"></a><span>
</span><a name="line-594"></a><span class="hs-identifier">toStrict</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">LBS.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">BS.ByteString</span><span>
</span><a name="line-595"></a><span class="hs-cpp">#if MIN_VERSION_bytestring(0,10,0)
</span><span class="hs-identifier">toStrict</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">LBS.toStrict</span><span>
</span><a name="line-597"></a><span class="hs-cpp">#else
</span><span class="hs-identifier">toStrict</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">BS.concat</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">LBS.toChunks</span><span>
</span><a name="line-599"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-601"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-603"></a><span class="hs-cpp">#if !(MIN_VERSION_base(4,5,0))
</span><span class="hs-special">(</span><span class="hs-operator">&lt;&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Monoid</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">m</span><span>
</span><a name="line-605"></a><span class="hs-special">(</span><span class="hs-operator">&lt;&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mappend</span><span>
</span><a name="line-606"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-608"></a></pre></body></html>